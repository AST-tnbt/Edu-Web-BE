# ===========================================
# API Gateway Configuration
# ===========================================

# Server port
server.port=${APIGATEWAY_SERVER_PORT:${SERVER_PORT:8080}}

# Application name
spring.application.name=apigateway

# ===========================================
# Eureka Client Configuration
# ===========================================

# Config Eureka Server - Sử dụng environment variable
eureka.client.service-url.defaultZone=${APIGATEWAY_EUREKA_SERVER_URL:${EUREKA_SERVER_URL:http://localhost:8761/eureka/}}
eureka.client.register-with-eureka=true
eureka.client.fetch-registry=true

# Instance configuration
eureka.instance.hostname=${APIGATEWAY_INSTANCE_HOSTNAME:${EUREKA_INSTANCE_HOSTNAME:apigateway}}
eureka.instance.prefer-ip-address=true
eureka.instance.lease-renewal-interval-in-seconds=30
eureka.instance.lease-expiration-duration-in-seconds=90

# ===========================================
# Gateway Configuration
# ===========================================

# Gateway discovery locator
spring.cloud.gateway.discovery.locator.enabled=true
spring.cloud.gateway.discovery.locator.lower-case-service-id=true

# ===========================================
# Load Balancer Configuration
# ===========================================

# Load balancer configuration
spring.cloud.loadbalancer.ribbon.enabled=false

# ===========================================
# Redis Configuration
# ===========================================

# Redis connection - Sử dụng environment variables
spring.data.redis.host=${APIGATEWAY_REDIS_HOST:${SPRING_DATA_REDIS_HOST:localhost}}
spring.data.redis.port=${APIGATEWAY_REDIS_PORT:${SPRING_DATA_REDIS_PORT:6379}}

# ===========================================
# Logging Configuration
# ===========================================

# Log level cho Gateway
logging.level.com.se347.apigateway=INFO
logging.level.org.springframework.cloud.gateway=INFO
logging.level.org.springframework.web.reactive=DEBUG

# ===========================================
# Management & Monitoring
# ===========================================

# Actuator endpoints
management.endpoints.web.exposure.include=health,info,metrics
management.endpoint.health.show-details=always
management.endpoint.health.show-components=always

# Health check configuration
management.health.redis.enabled=true
management.health.db.enabled=true

# Gateway actuator
management.endpoint.gateway.enabled=true

# ===========================================
# JWT Configuration
# ===========================================

# JWT secret key (use environment variable)
jwt.secret=${APIGATEWAY_JWT_SECRET:${JWT_SECRET:change-me}}
jwt.expiration=${APIGATEWAY_JWT_EXPIRATION:${JWT_EXPIRATION:86400000}}

# ===========================================
# HMAC Configuration
# ===========================================

# HMAC secret key for request signing (use environment variable)
gateway.hmac.secret=${APIGATEWAY_HMAC_SECRET:${GATEWAY_HMAC_SECRET:change-me-hmac}}
gateway.hmac.enabled=${APIGATEWAY_HMAC_ENABLED:${GATEWAY_HMAC_ENABLED:true}}

# ===========================================
# CORS Configuration
# ===========================================
gateway.cors.allowed-origins=${APIGATEWAY_CORS_ALLOWED_ORIGINS:http://localhost:5173}

# ===========================================
# Gateway Routes & Rate Limiting
# ===========================================

# Auth Service Route
spring.cloud.gateway.routes[0].id=auth-service
spring.cloud.gateway.routes[0].uri=lb://authservice
spring.cloud.gateway.routes[0].predicates[0]=Path=/api/auth/**
spring.cloud.gateway.routes[0].filters[0]=AddRequestHeader=X-Gateway-Source,api-gateway
spring.cloud.gateway.routes[0].filters[1].name=HmacSigningFilter

# User Service Route  
spring.cloud.gateway.routes[1].id=user-service
spring.cloud.gateway.routes[1].uri=lb://userservice
spring.cloud.gateway.routes[1].predicates[0]=Path=/api/users/**
spring.cloud.gateway.routes[1].filters[0]=AddRequestHeader=X-Gateway-Source,api-gateway
spring.cloud.gateway.routes[1].filters[1].name=JwtAuthenticationFilter
spring.cloud.gateway.routes[1].filters[2].name=HmacSigningFilter
spring.cloud.gateway.routes[1].filters[3].name=RequestRateLimiter
spring.cloud.gateway.routes[1].filters[3].args.redis-rate-limiter.replenishRate=${APIGATEWAY_RATE_LIMIT_REPLENISH_RATE:${RATE_LIMIT_REPLENISH_RATE:10}}
spring.cloud.gateway.routes[1].filters[3].args.redis-rate-limiter.burstCapacity=${APIGATEWAY_RATE_LIMIT_BURST_CAPACITY:${RATE_LIMIT_BURST_CAPACITY:20}}
spring.cloud.gateway.routes[1].filters[3].args.redis-rate-limiter.requestedTokens=${APIGATEWAY_RATE_LIMIT_REQUESTED_TOKENS:${RATE_LIMIT_REQUESTED_TOKENS:1}}
spring.cloud.gateway.routes[1].filters[3].args.key-resolver=#{@ipKeyResolver}

# Enrollment Service Route
spring.cloud.gateway.routes[2].id=enrollment-service
spring.cloud.gateway.routes[2].uri=lb://enrollmentservice
spring.cloud.gateway.routes[2].order=-1
spring.cloud.gateway.routes[2].predicates[0]=Path=/api/enrollments/**,/api/learning-progress/**,/api/course-progress/**,/api/courses/id/*/enroll,/api/courses/id/*/enrollments/**,/api/admin/enrollments/**
spring.cloud.gateway.routes[2].filters[0]=AddRequestHeader=X-Gateway-Source,api-gateway
spring.cloud.gateway.routes[2].filters[1].name=JwtAuthenticationFilter
spring.cloud.gateway.routes[2].filters[2].name=HmacSigningFilter
spring.cloud.gateway.routes[2].filters[3].name=RequestRateLimiter
spring.cloud.gateway.routes[2].filters[3].args.redis-rate-limiter.replenishRate=${APIGATEWAY_RATE_LIMIT_REPLENISH_RATE:${RATE_LIMIT_REPLENISH_RATE:10}}
spring.cloud.gateway.routes[2].filters[3].args.redis-rate-limiter.burstCapacity=${APIGATEWAY_RATE_LIMIT_BURST_CAPACITY:${RATE_LIMIT_BURST_CAPACITY:20}}
spring.cloud.gateway.routes[2].filters[3].args.redis-rate-limiter.requestedTokens=${APIGATEWAY_RATE_LIMIT_REQUESTED_TOKENS:${RATE_LIMIT_REQUESTED_TOKENS:1}}
spring.cloud.gateway.routes[2].filters[3].args.key-resolver=#{@ipKeyResolver}

# Course Service Route
spring.cloud.gateway.routes[3].id=course-service
spring.cloud.gateway.routes[3].uri=lb://courseservice
spring.cloud.gateway.routes[3].predicates[0]=Path=/api/courses/**,/api/categories/**,/api/sections/**,/api/lessons/**,/api/contents/**
spring.cloud.gateway.routes[3].filters[0]=AddRequestHeader=X-Gateway-Source,api-gateway
spring.cloud.gateway.routes[3].filters[1].name=JwtAuthenticationFilter
spring.cloud.gateway.routes[3].filters[2].name=HmacSigningFilter
spring.cloud.gateway.routes[3].filters[3].name=RequestRateLimiter
spring.cloud.gateway.routes[3].filters[3].args.redis-rate-limiter.replenishRate=${APIGATEWAY_RATE_LIMIT_REPLENISH_RATE:${RATE_LIMIT_REPLENISH_RATE:10}}
spring.cloud.gateway.routes[3].filters[3].args.redis-rate-limiter.burstCapacity=${APIGATEWAY_RATE_LIMIT_BURST_CAPACITY:${RATE_LIMIT_BURST_CAPACITY:20}}
spring.cloud.gateway.routes[3].filters[3].args.redis-rate-limiter.requestedTokens=${APIGATEWAY_RATE_LIMIT_REQUESTED_TOKENS:${RATE_LIMIT_REQUESTED_TOKENS:1}}
spring.cloud.gateway.routes[3].filters[3].args.key-resolver=#{@ipKeyResolver}

# Content Service Route
spring.cloud.gateway.routes[4].id=content-service
spring.cloud.gateway.routes[4].uri=lb://contentservice
spring.cloud.gateway.routes[4].predicates[0]=Path=/api/content-files/**
spring.cloud.gateway.routes[4].filters[0]=AddRequestHeader=X-Gateway-Source,api-gateway
spring.cloud.gateway.routes[4].filters[1].name=JwtAuthenticationFilter
spring.cloud.gateway.routes[4].filters[2].name=HmacSigningFilter
spring.cloud.gateway.routes[4].filters[3].name=RequestRateLimiter
spring.cloud.gateway.routes[4].filters[3].args.redis-rate-limiter.replenishRate=${APIGATEWAY_RATE_LIMIT_REPLENISH_RATE:${RATE_LIMIT_REPLENISH_RATE:10}}
spring.cloud.gateway.routes[4].filters[3].args.redis-rate-limiter.burstCapacity=${APIGATEWAY_RATE_LIMIT_BURST_CAPACITY:${RATE_LIMIT_BURST_CAPACITY:20}}
spring.cloud.gateway.routes[4].filters[3].args.redis-rate-limiter.requestedTokens=${APIGATEWAY_RATE_LIMIT_REQUESTED_TOKENS:${RATE_LIMIT_REQUESTED_TOKENS:1}}
spring.cloud.gateway.routes[4].filters[3].args.key-resolver=#{@ipKeyResolver}

# Payment Service Route
spring.cloud.gateway.routes[5].id=payment-service
spring.cloud.gateway.routes[5].uri=lb://paymentservice
spring.cloud.gateway.routes[5].predicates[0]=Path=/api/payment/**
spring.cloud.gateway.routes[5].filters[0]=AddRequestHeader=X-Gateway-Source,api-gateway
spring.cloud.gateway.routes[5].filters[1].name=JwtAuthenticationFilter
spring.cloud.gateway.routes[5].filters[2].name=HmacSigningFilter
spring.cloud.gateway.routes[5].filters[3].name=RequestRateLimiter
spring.cloud.gateway.routes[5].filters[3].args.redis-rate-limiter.replenishRate=${APIGATEWAY_RATE_LIMIT_REPLENISH_RATE:${RATE_LIMIT_REPLENISH_RATE:10}}
spring.cloud.gateway.routes[5].filters[3].args.redis-rate-limiter.burstCapacity=${APIGATEWAY_RATE_LIMIT_BURST_CAPACITY:${RATE_LIMIT_BURST_CAPACITY:20}}
spring.cloud.gateway.routes[5].filters[3].args.redis-rate-limiter.requestedTokens=${APIGATEWAY_RATE_LIMIT_REQUESTED_TOKENS:${RATE_LIMIT_REQUESTED_TOKENS:1}}
spring.cloud.gateway.routes[5].filters[3].args.key-resolver=#{@ipKeyResolver}
